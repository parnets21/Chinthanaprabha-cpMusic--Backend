import{j as e,i as ye,k as ve,f as ee,l as we,F as Ce}from"../assets/index-BFsjM1Ls.js";import{r as d}from"./chunk-CTJ-xxG2.js";import{a as x}from"./chunk-ngrFHoWO.js";import"./chunk-DS08_OVb.js";import"./chunk-Cjtwp2vM.js";import"./chunk-nx6VVHRj.js";const Ee=()=>{var J,Q,X;const[f,w]=d.useState([]),[k,C]=d.useState(!0),[D,T]=d.useState(""),[z,B]=d.useState([]),[V,q]=d.useState(!1),[I,R]=d.useState(""),[se,b]=d.useState(!1),[h,S]=d.useState(""),[m,$]=d.useState(null),[i,u]=d.useState({name:"",description:"",price:"",instructor:"",image:null,lessons:[{videoFiles:[],lessonNumber:"",lessonIntro:""}]}),[te,L]=d.useState({}),[O,E]=d.useState({}),[P,W]=d.useState({}),[N,G]=d.useState(!1),[Y,v]=d.useState(0),[p,ae]=d.useState(1),M=5;d.useEffect(()=>{A(),re()},[]),d.useEffect(()=>()=>{Object.values(P).forEach(s=>s.abort()),console.log("Cancelled all uploads on unmount")},[P]),d.useEffect(()=>{if(!N)return;const s=setInterval(()=>{v(t=>{const r=Math.min(t+5,95);return t>=95?95:r})},500);return()=>clearInterval(s)},[N]);const g=async s=>{var t;try{const r=await s;return console.log("API Response:",r.data),r}catch(r){throw console.error("API Error:",((t=r.response)==null?void 0:t.data)||r.message),r}},A=async()=>{C(!0),T("");try{const s=await g(x.get("https://cpsangeetha.com/chinthanaprabha/courses-lessons/courses"));w(s.data||[])}catch{T("Failed to load courses")}finally{C(!1)}},re=async()=>{q(!0),R("");try{const s=await g(x.get("https://cpsangeetha.com/chinthanaprabha/teacher-auth/teachers"));B(s.data||[])}catch{R("Failed to load instructors"),B([])}finally{q(!1)}},ne=async(s,t,r)=>{var o,n;const a=new AbortController;W(l=>({...l,[t]:a})),L(l=>({...l,[t]:!0})),E(l=>({...l,[t]:0}));try{const l=new FormData;l.append(r.includes("thumbnail")?"thumbnail":"video",s);const c=await x.post(r,l,{headers:{"Content-Type":"multipart/form-data"},signal:a.signal,timeout:600*1e3,onUploadProgress:({loaded:y,total:Z})=>{const K=Math.round(y/Z*100);E(Ne=>({...Ne,[t]:K})),console.log(`ðŸ“Š Upload ${t}: ${K}% (${(y/1024/1024).toFixed(2)}MB/${(Z/1024/1024).toFixed(2)}MB)`)}});return L(y=>({...y,[t]:!1})),c.data.location}catch(l){throw l.name==="AbortError"?new Error("Upload cancelled"):new Error(((n=(o=l.response)==null?void 0:o.data)==null?void 0:n.error)||l.message)}finally{W(l=>{const c={...l};return delete c[t],c})}},le=async(s,t)=>{const r=Array.from(t.target.files);if(!r.length)return;const a=r.filter(o=>o.type.startsWith("video/")?o.size>10*1024*1024*1024?(alert(`${o.name} exceeds 10GB limit`),!1):!0:(alert(`${o.name} is not a video file`),!1));if(a.length!==0)try{const o=await Promise.all(a.map(async(n,l)=>{const c=`lesson-${s}-file-${Date.now()}-${l}`,y=await ne(n,c,"https://cpsangeetha.com/chinthanaprabha/upload-video");return{name:n.name,size:n.size,type:n.type,url:y}}));u(n=>({...n,lessons:n.lessons.map((l,c)=>c===s?{...l,videoFiles:[...l.videoFiles||[],...o]}:l)})),alert(`Successfully uploaded ${o.length} video(s)`)}catch(o){alert(`Upload failed: ${o.message}`)}finally{t.target.value=""}},oe=(s,t)=>{u(r=>({...r,lessons:r.lessons.map((a,o)=>o===s?{...a,videoFiles:a.videoFiles.filter((n,l)=>l!==t)}:a)}))},ie=s=>{window.confirm("Remove all videos from this lesson?")&&u(t=>({...t,lessons:t.lessons.map((r,a)=>a===s?{...r,videoFiles:[]}:r)}))},ce=s=>{const t=P[s];t&&(t.abort(),L(r=>({...r,[s]:!1})),E(r=>({...r,[s]:0})),alert("Upload cancelled"))},j=(s,t=-1)=>{const{name:r,value:a,files:o}=s.target;u(r==="image"?n=>({...n,image:o[0]}):t===-1?n=>({...n,[r]:a}):n=>({...n,lessons:n.lessons.map((l,c)=>c===t?{...l,[r]:a}:l)}))},de=()=>{u(s=>({...s,lessons:[...s.lessons,{videoFiles:[],lessonNumber:"",lessonIntro:""}]}))},me=s=>{u(t=>({...t,lessons:t.lessons.filter((r,a)=>a!==s)}))},ue=()=>{S("add"),$(null),u({name:"",description:"",price:"",instructor:"",image:null,lessons:[{videoFiles:[],lessonNumber:"",lessonIntro:""}]}),b(!0)},he=s=>{var t,r;S("edit"),$(s),u({name:s.name||"",description:s.description||"",price:s.price||"",instructor:((t=s.instructor)==null?void 0:t._id)||s.instructor||"",image:null,currentImage:s.image,lessons:(r=s.lessons)!=null&&r.length?s.lessons.map(a=>{var o;return{lessonNumber:a.lessonNumber||"",lessonIntro:a.lessonIntro||"",videoFiles:((o=a.videoUrls)==null?void 0:o.map(n=>({url:n,name:n.split("/").pop(),size:0,type:"video/mp4"})))||[],_id:a._id}}):[{videoFiles:[],lessonNumber:"",lessonIntro:""}]}),b(!0)},xe=s=>{S("view"),$(s),b(!0)},pe=async s=>{if(confirm("Are you sure you want to delete this course?"))try{await g(x.delete(`https://cpsangeetha.com/chinthanaprabha/courses-lessons/courses/${s}`)),w(f.filter(t=>t._id!==s))}catch{alert("Failed to delete course")}},ge=async s=>{var t,r;if(s.preventDefault(),!i.name||!i.description||!i.price||!i.instructor){alert("Please fill in all required fields");return}if(h==="add"&&!i.image){alert("Please select a course image");return}G(!0),v(0);try{const a=new FormData;a.append("name",i.name),a.append("description",i.description),a.append("price",i.price),a.append("instructor",i.instructor),i.image&&a.append("thumbnail",i.image);let o;h==="add"?(o=(await g(x.post("https://cpsangeetha.com/chinthanaprabha/upload-thumbnail",a,{headers:{"Content-Type":"multipart/form-data"}}))).data._id,v(50)):(o=m._id,await g(x.put(`https://cpsangeetha.com/chinthanaprabha/courses-lessons/courses/${o}`,a,{headers:{"Content-Type":"multipart/form-data"}})),v(50));for(const n of i.lessons)if((t=n.videoFiles)!=null&&t.length||n.lessonNumber||n.lessonIntro){const l=new FormData;l.append("lessonNumber",n.lessonNumber),l.append("lessonIntro",n.lessonIntro),(r=n.videoFiles)==null||r.forEach(c=>{c.url&&l.append("videoUrls",c.url)}),n._id?await g(x.put(`https://cpsangeetha.com/chinthanaprabha/courses-lessons/lessons/${n._id}`,l,{headers:{"Content-Type":"multipart/form-data"}})):await g(x.post(`https://cpsangeetha.com/chinthanaprabha/courses-lessons/courses/${o}/lessons`,l,{headers:{"Content-Type":"multipart/form-data"}}))}if(h==="edit"&&m.lessons){const n=i.lessons.filter(c=>c._id).map(c=>c._id),l=m.lessons.filter(c=>!n.includes(c._id));for(const c of l)await g(x.delete(`https://cpsangeetha.com/chinthanaprabha/courses-lessons/lessons/${c._id}`))}v(100),alert(h==="add"?"Course added successfully!":"Course updated successfully!"),b(!1),await A()}catch(a){alert(`Error saving course: ${a.message}`)}finally{G(!1)}},H=p*M,fe=H-M,be=f.slice(fe,H),F=Math.ceil(f.length/M),_=s=>ae(s),je=s=>{if(s===0)return"0 Bytes";const t=1024,r=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(s)/Math.log(t));return`${(s/Math.pow(t,a)).toFixed(2)} ${r[a]}`};return e.jsxs("div",{className:"h-screen p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Course Management"}),e.jsx("button",{onClick:ue,className:"bg-black text-white px-4 py-2 rounded",children:"Add New Course"})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-md overflow-x-auto",children:k?e.jsx("div",{className:"p-8 text-center",children:"Loading courses..."}):D?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("p",{className:"text-red-600 mb-4",children:D}),e.jsx("button",{onClick:A,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Retry"})]}):f.length===0?e.jsx("div",{className:"p-8 text-center",children:"No courses found. Add your first course!"}):e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-800 text-white",children:[e.jsx("th",{className:"w-16 px-4 py-2 text-center",children:"ID"}),e.jsx("th",{className:"w-20 px-4 py-2 text-center",children:"Image"}),e.jsx("th",{className:"px-4 py-2 text-center",children:"Name"}),e.jsx("th",{className:"px-4 py-2 text-center",children:"Instructor"}),e.jsx("th",{className:"w-20 px-4 py-2 text-center",children:"Videos"}),e.jsx("th",{className:"w-20 px-4 py-2 text-center",children:"Lessons"}),e.jsx("th",{className:"w-20 px-4 py-2 text-center",children:"Price"}),e.jsx("th",{className:"w-32 px-4 py-2 text-center",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:be.map(s=>{var t;return e.jsxs("tr",{className:"hover:bg-gray-100",children:[e.jsx("td",{className:"px-4 py-2",children:s._id.substring(0,6)}),e.jsx("td",{className:"px-4 py-2",children:e.jsx(U,{image:s.image,name:s.name})}),e.jsx("td",{className:"px-4 py-2",children:s.name}),e.jsx("td",{className:"px-4 py-2",children:((t=s.instructor)==null?void 0:t.name)||"N/A"}),e.jsx("td",{className:"px-4 py-2",children:s.lessons.reduce((r,a)=>{var o;return r+(((o=a.videoUrls)==null?void 0:o.length)||0)},0)}),e.jsx("td",{className:"px-4 py-2",children:s.lessons.length}),e.jsxs("td",{className:"px-4 py-2",children:["â‚¹",s.price]}),e.jsxs("td",{className:"px-4 py-2 space-x-3 text-right",children:[e.jsx("button",{onClick:()=>xe(s),className:"text-indigo-600 hover:text-indigo-900",children:e.jsx(ye,{size:18})}),e.jsx("button",{onClick:()=>he(s),className:"text-blue-600 hover:text-blue-900",children:e.jsx(ve,{size:18})}),e.jsx("button",{onClick:()=>pe(s._id),className:"text-red-600 hover:text-red-900",children:e.jsx(ee,{size:18})})]})]},s._id)})})]})}),e.jsx("div",{className:"flex justify-end mt-4 mb-4 pr-4",children:e.jsxs("nav",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>_(Math.max(1,p-1)),disabled:p===1,className:`px-3 py-1 mx-1 rounded ${p===1?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-gray-200 hover:bg-gray-300 text-gray-700"}`,children:"Previous"}),Array.from({length:F},(s,t)=>t+1).map(s=>e.jsx("button",{onClick:()=>_(s),className:`px-3 py-1 mx-1 rounded ${p===s?"bg-black text-white":"bg-gray-200 hover:bg-gray-300 text-gray-700"}`,children:s},s)),e.jsx("button",{onClick:()=>_(Math.min(F,p+1)),disabled:p===F,className:`px-3 py-1 mx-1 rounded ${p===F?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-gray-200 hover:bg-gray-300 text-gray-700"}`,children:"Next"})]})}),se&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg max-h-[85vh] overflow-y-auto",children:[e.jsx("button",{onClick:()=>b(!1),className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("h2",{className:"text-xl font-bold mb-4 text-left",children:h==="view"?"Course Details":h==="add"?"Add New Course":"Edit Course"}),h==="view"&&m?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-left",children:"Course Image"}),e.jsx(U,{image:m.image,name:m.name})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-left",children:"Course Name"}),e.jsx("p",{children:m.name})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-left",children:"Description"}),e.jsx("p",{children:m.description})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-left",children:"Instructor"}),e.jsx("p",{children:((J=m.instructor)==null?void 0:J.name)||"N/A"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-left",children:"Price"}),e.jsxs("p",{children:["â‚¹",m.price]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-left",children:"Lessons"}),e.jsx("ul",{className:"list-disc pl-5",children:(Q=m.lessons)==null?void 0:Q.map((s,t)=>e.jsxs("li",{children:["Lesson ",s.lessonNumber,": ",s.lessonIntro]},t))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-left",children:"Videos"}),((X=m.lessons)==null?void 0:X.flatMap(s=>{var t;return(t=s.videoUrls)==null?void 0:t.map((r,a)=>e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg mb-2",children:[e.jsxs("p",{className:"text-sm font-medium",children:["Lesson ",s.lessonNumber," - Video ",a+1]}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:r}),e.jsx("video",{src:r,controls:!0,className:"w-full h-64 mt-2 rounded-lg",preload:"metadata",children:"Your browser does not support the video tag."})]},a))}))||e.jsx("p",{className:"text-gray-500",children:"No videos available."})]}),e.jsx("button",{onClick:()=>b(!1),className:"w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"Close"})]}):e.jsxs("form",{onSubmit:ge,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-left",children:"Course Image"}),e.jsx("input",{type:"file",name:"image",accept:"image/*",onChange:j,className:"mt-1 w-full"}),h==="edit"&&i.currentImage&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Current image:"}),e.jsx(U,{image:i.currentImage,name:i.name})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-left",children:"Course Name"}),e.jsx("input",{type:"text",name:"name",value:i.name,onChange:j,className:"mt-1 w-full px-3 py-2 border rounded-md",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-left",children:"Description"}),e.jsx("textarea",{name:"description",value:i.description,onChange:j,rows:3,className:"mt-1 w-full px-3 py-2 border rounded-md",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-left",children:"Instructor"}),e.jsxs("select",{name:"instructor",value:i.instructor,onChange:j,className:"mt-1 w-full px-3 py-2 border rounded-md",required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:V?"Loading...":"Select an instructor"}),I&&e.jsx("option",{value:"",disabled:!0,children:I}),!V&&!I&&z.length===0&&e.jsx("option",{value:"",disabled:!0,children:"No instructors found"}),z.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-left",children:"Price"}),e.jsx("input",{type:"number",name:"price",value:i.price,onChange:j,className:"mt-1 w-full px-3 py-2 border rounded-md",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-left",children:"Lessons"}),i.lessons.map((s,t)=>{var r;return e.jsxs("div",{className:"mt-4 p-4 border rounded-md",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsxs("h4",{className:"text-lg font-medium",children:["Lesson ",t+1]}),e.jsx("button",{type:"button",onClick:()=>me(t),className:"text-red-600 hover:text-red-800",children:e.jsx(we,{})})]}),e.jsx("input",{type:"text",placeholder:"Lesson Number",name:"lessonNumber",value:s.lessonNumber,onChange:a=>j(a,t),className:"w-full px-3 py-2 border rounded-md mb-2",required:!0}),e.jsx("input",{type:"text",placeholder:"Lesson Intro",name:"lessonIntro",value:s.lessonIntro,onChange:a=>j(a,t),className:"w-full px-3 py-2 border rounded-md mb-2",required:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-left",children:"Videos (Up to 10GB)"}),e.jsx("input",{type:"file",accept:"video/*",multiple:!0,onChange:a=>le(t,a),className:"mt-1 w-full"}),Object.keys(te).filter(a=>a.startsWith(`lesson-${t}-`)).map(a=>e.jsxs("div",{className:"mt-2 p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{children:"Uploading video..."}),e.jsx("button",{onClick:()=>ce(a),className:"text-red-600 hover:text-red-800",children:"Cancel"})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${O[a]||0}%`}})}),e.jsxs("p",{className:"text-xs mt-1",children:[O[a]||0,"%"]})]},a)),((r=s.videoFiles)==null?void 0:r.length)>0&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("p",{children:["Added Videos (",s.videoFiles.length,")"]}),e.jsx("button",{type:"button",onClick:()=>ie(t),className:"text-red-600 hover:text-red-800",children:"Clear All"})]}),s.videoFiles.map((a,o)=>e.jsxs("div",{className:"flex justify-between mt-1 bg-gray-50 p-2 rounded",children:[e.jsxs("span",{className:"truncate",children:[a.name," (",je(a.size),")",a.url&&e.jsx("span",{className:"ml-1 text-green-600",children:"(Uploaded)"})]}),e.jsx("button",{type:"button",onClick:()=>oe(t,o),className:"text-red-600 hover:text-red-800",children:e.jsx(ee,{size:14})})]},o))]})]})]},t)}),e.jsxs("button",{type:"button",onClick:de,className:"mt-2 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600",children:[e.jsx(Ce,{className:"inline-block mr-2"})," Add Lesson"]})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:N,className:`flex-1 px-4 py-2 rounded text-white ${N?"bg-blue-300":"bg-blue-500 hover:bg-blue-600"}`,children:N?`Processing... ${Y}%`:h==="add"?"Add Course":"Update Course"}),N&&e.jsx("div",{className:"w-40",children:e.jsx("div",{className:"h-2 bg-gray-200 rounded",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded",style:{width:`${Y}%`}})})}),e.jsx("button",{type:"button",onClick:()=>b(!1),className:"flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",children:"Cancel"})]})]})]})})]})},U=({image:f,name:w})=>{const[k,C]=d.useState(!1);return e.jsx("img",{src:k||!f?"/placeholder.svg":f,alt:w,className:"h-10 w-10 rounded-full",onError:()=>C(!0)})};export{Ee as default};
